<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PS Rental Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 20px;
        color: white;
      }

      .nav-tabs {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 30px;
      }

      .nav-tab {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        padding: 12px 20px;
        border-radius: 25px;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .nav-tab:hover,
      .nav-tab.active {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
      }

      .tab-content {
        display: none;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .tab-content.active {
        display: block;
        animation: fadeIn 0.5s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-row {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
      }

      .form-col {
        flex: 1;
        min-width: 200px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #555;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 16px;
        transition: border-color 0.3s ease;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-danger {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
      }

      .btn-warning {
        background: linear-gradient(45deg, #ffa726, #ff7043);
      }

      .filter-section {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: end;
      }

      .filter-group {
        flex: 1;
        min-width: 150px;
      }

      .card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border-left: 5px solid #667eea;
        transition: transform 0.3s ease;
      }

      .card:hover {
        transform: translateX(5px);
      }

      .card-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 15px;
      }

      .card-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
      }

      .card-actions {
        display: flex;
        gap: 10px;
      }

      .status-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-available {
        background: #d4edda;
        color: #155724;
      }

      .status-rented {
        background: #f8d7da;
        color: #721c24;
      }

      .status-maintenance {
        background: #fff3cd;
        color: #856404;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 25px;
        border-radius: 15px;
        text-align: center;
      }

      .stat-number {
        font-size: 2.5em;
        font-weight: bold;
        margin-bottom: 10px;
      }

      .stat-label {
        font-size: 1.1em;
        opacity: 0.9;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
      }

      .modal-content {
        background: white;
        margin: 5% auto;
        padding: 30px;
        border-radius: 20px;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close:hover {
        color: #000;
      }

      .member-card {
        background: linear-gradient(135deg, #84fab0, #8fd3f4);
        color: #333;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 15px;
      }

      .member-type {
        display: inline-block;
        padding: 5px 15px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 10px;
      }

      @media (max-width: 768px) {
        .container {
          padding: 15px;
        }

        .form-row {
          flex-direction: column;
        }

        .filter-section {
          flex-direction: column;
        }

        .card-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .card-actions {
          width: 100%;
          justify-content: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1><i class="fas fa-gamepad"></i> PS Rental Tracker</h1>
        <p>Sistem Manajemen Rental PlayStation</p>
      </div>

      <div class="nav-tabs">
        <button class="nav-tab active" onclick="showTab('konsol')">
          <i class="fas fa-gamepad"></i> Konsol PS
        </button>
        <button class="nav-tab" onclick="showTab('booking')">
          <i class="fas fa-calendar-check"></i> Booking
        </button>
        <button class="nav-tab" onclick="showTab('member')">
          <i class="fas fa-users"></i> Member
        </button>
        <button class="nav-tab" onclick="showTab('rekap')">
          <i class="fas fa-chart-bar"></i> Rekap Bulanan
        </button>
      </div>

      <!-- Tab Konsol PS -->
      <div id="konsol" class="tab-content active">
        <div
          id="konsolDashboard"
          class="stats-grid"
          style="margin-bottom: 20px"
        ></div>

        <h2>Manajemen Konsol PlayStation</h2>

        <div class="form-group">
          <h3>Tambah Konsol Baru</h3>
          <div class="form-row">
            <div class="form-col">
              <label>Nama Konsol</label>
              <input type="text" id="konsolNama" placeholder="Contoh: PS5 #1" />
            </div>
            <div class="form-col">
              <label>Jenis</label>
              <select id="konsolJenis">
                <option value="PS5">PlayStation 5</option>
                <option value="PS4">PlayStation 4</option>
                <option value="PS3">PlayStation 3</option>
                <option value="PS2">PlayStation 2</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-col">
              <label>Harga per Jam (Rp)</label>
              <input type="number" id="konsolHarga" placeholder="10000" />
            </div>
            <div class="form-col">
              <label>Status</label>
              <select id="konsolStatus">
                <option value="tersedia">Tersedia</option>
                <option value="disewa">Disewa</option>
                <option value="maintenance">Maintenance</option>
              </select>
            </div>
          </div>
          <button class="btn" onclick="tambahKonsol()">
            <i class="fas fa-plus"></i> Tambah Konsol
          </button>
        </div>

        <div class="filter-section">
          <div class="filter-group">
            <label>Filter Jenis</label>
            <select id="filterJenis" onchange="filterKonsol()">
              <option value="">Semua Jenis</option>
              <option value="PS5">PlayStation 5</option>
              <option value="PS4">PlayStation 4</option>
              <option value="PS3">PlayStation 3</option>
              <option value="PS2">PlayStation 2</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Filter Status</label>
            <select id="filterStatus" onchange="filterKonsol()">
              <option value="">Semua Status</option>
              <option value="tersedia">Tersedia</option>
              <option value="disewa">Disewa</option>
              <option value="maintenance">Maintenance</option>
            </select>
          </div>
          <div class="filter-group">
            <button class="btn" onclick="resetFilter()">
              <i class="fas fa-refresh"></i> Reset Filter
            </button>
          </div>
        </div>

        <div id="daftarKonsol"></div>
      </div>

      <!-- Tab Booking -->
      <div id="booking" class="tab-content">
        <h2>Manajemen Booking</h2>

        <div class="form-group">
          <h3>Tambah Booking Baru</h3>
          <div class="form-row">
            <div class="form-col">
              <label>Nama Customer</label>
              <input type="text" id="bookingNama" placeholder="Nama customer" />
            </div>
            <div class="form-col">
              <label>Konsol</label>
              <select id="bookingKonsol"></select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-col">
              <label>Tanggal & Waktu Mulai</label>
              <input type="datetime-local" id="bookingMulai" />
            </div>
            <div class="form-col">
              <label>Durasi (Jam)</label>
              <input type="number" id="bookingDurasi" placeholder="2" min="1" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-col">
              <label>Member</label>
              <select id="bookingMember">
                <option value="">Bukan Member</option>
              </select>
            </div>
          </div>
          <button class="btn" onclick="tambahBooking()">
            <i class="fas fa-calendar-plus"></i> Tambah Booking
          </button>
        </div>

        <div id="daftarBooking"></div>
      </div>

      <!-- Tab Member -->
      <div id="member" class="tab-content">
        <h2>Manajemen Member</h2>

        <div class="form-group">
          <h3>Tambah Member Baru</h3>
          <div class="form-row">
            <div class="form-col">
              <label>Nama Member</label>
              <input type="text" id="memberNama" placeholder="Nama lengkap" />
            </div>
            <div class="form-col">
              <label>No. Telepon</label>
              <input type="tel" id="memberTelepon" placeholder="08123456789" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-col">
              <label>Email</label>
              <input
                type="email"
                id="memberEmail"
                placeholder="email@example.com"
              />
            </div>
            <div class="form-col">
              <label>Jenis Member</label>
              <select id="memberJenis">
                <option value="bronze">Bronze (5% discount)</option>
                <option value="silver">Silver (10% discount)</option>
                <option value="gold">Gold (15% discount)</option>
                <option value="platinum">Platinum (20% discount)</option>
              </select>
            </div>
          </div>
          <button class="btn" onclick="tambahMember()">
            <i class="fas fa-user-plus"></i> Tambah Member
          </button>
        </div>

        <div id="daftarMember"></div>
      </div>

      <!-- Tab Rekap -->
      <div id="rekap" class="tab-content">
        <h2>Rekap Bulanan</h2>

        <div class="form-group">
          <div class="form-row">
            <div class="form-col">
              <label>Pilih Bulan</label>
              <input type="month" id="rekapBulan" />
            </div>
            <div class="form-col" style="display: flex; align-items: end">
              <button class="btn" onclick="generateRekap()">
                <i class="fas fa-chart-line"></i> Generate Rekap
              </button>
              <button class="btn btn-danger" onclick="resetRekap()">
                <i class="fas fa-times-circle"></i> Reset Rekap
              </button>

              <button class="btn" onclick="handleEksporPDF()">
                Ekspor PDF Rekap
              </button>

              <div id="exportPDFModal" class="modal">
                <div class="modal-content">
                  <span class="close" onclick="tutupExportPDFModal()"
                    >&times;</span
                  >
                  <h3>Pilih Bulan untuk Diekspor</h3>
                  <div class="form-group">
                    <label>Pilih Bulan</label>
                    <select
                      id="bulanExport"
                      multiple
                      style="width: 100%; height: 150px"
                    >
                      <!-- JS akan isi otomatis -->
                    </select>
                  </div>
                  <button class="btn" onclick="eksporRekapBeberapaBulan()">
                    Download PDF
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="hasilRekap"></div>
      </div>
    </div>

    <!-- Modal Edit -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 id="modalTitle">Edit Item</h3>
        <div id="modalBody"></div>
        <div style="margin-top: 20px; text-align: right">
          <button class="btn" id="saveBtn">
            <i class="fas fa-save"></i> Simpan
          </button>
        </div>
      </div>
    </div>

    <script>
      // Data Storage
      let data = {
        konsol: [],
        booking: [],
        member: [],
        nextId: {
          konsol: 1,
          booking: 1,
          member: 1,
        },
      };

      // Load data from memory or initialize
      function loadData() {
        const saved = localStorage.getItem("psRentalData");
        if (saved) {
          data = JSON.parse(saved);
        } else {
          initSampleData();
          saveData();
        }
      }

      function saveData() {
        localStorage.setItem("psRentalData", JSON.stringify(data));
      }

      function initSampleData() {
        // Sample konsol
        data.konsol = [
          {
            id: 1,
            nama: "PS5 #1",
            jenis: "PS5",
            harga: 15000,
            status: "tersedia",
          },
          {
            id: 2,
            nama: "PS4 Pro #1",
            jenis: "PS4",
            harga: 10000,
            status: "tersedia",
          },
          {
            id: 3,
            nama: "PS4 Slim #1",
            jenis: "PS4",
            harga: 8000,
            status: "disewa",
          },
        ];
        data.nextId.konsol = 4;

        // Sample members
        data.member = [
          {
            id: 1,
            nama: "John Doe",
            telepon: "08123456789",
            email: "john@email.com",
            jenis: "gold",
          },
          {
            id: 2,
            nama: "Jane Smith",
            telepon: "08987654321",
            email: "jane@email.com",
            jenis: "silver",
          },
        ];
        data.nextId.member = 3;

        // Sample bookings
        const today = new Date();
        data.booking = [
          {
            id: 1,
            nama: "Ahmad",
            konsolId: 3,
            konsolNama: "PS4 Slim #1",
            mulai: new Date(today.getTime() - 2 * 60 * 60 * 1000).toISOString(),
            durasi: 3,
            member: null,
            total: 24000,
            status: "aktif",
          },
        ];
        data.nextId.booking = 2;
      }

      // Tab Management
      function showTab(tabName) {
        // Hide all tabs
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });
        document.querySelectorAll(".nav-tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Show selected tab
        document.getElementById(tabName).classList.add("active");
        event.target.classList.add("active");

        // Refresh data display
        switch (tabName) {
          case "konsol":
            displayKonsol();
            break;
          case "booking":
            displayBooking();
            updateBookingKonsolOptions();
            updateBookingMemberOptions();
            break;
          case "member":
            displayMember();
            break;
          case "rekap":
            document.getElementById("rekapBulan").value = new Date()
              .toISOString()
              .slice(0, 7);
            break;
        }
      }

      // Konsol Management
      function tambahKonsol() {
        const nama = document.getElementById("konsolNama").value;
        const jenis = document.getElementById("konsolJenis").value;
        const harga = parseInt(document.getElementById("konsolHarga").value);
        const status = document.getElementById("konsolStatus").value;

        if (!nama || !harga) {
          alert("Nama konsol dan harga harus diisi!");
          return;
        }

        const konsol = {
          id: data.nextId.konsol++,
          nama,
          jenis,
          harga,
          status,
        };

        data.konsol.push(konsol);
        saveData();
        displayKonsol();

        // Clear form
        document.getElementById("konsolNama").value = "";
        document.getElementById("konsolHarga").value = "";
      }

      function displayKonsol() {
        let filtered = [...data.konsol];

        const jenisFilter = document.getElementById("filterJenis").value;
        const statusFilter = document.getElementById("filterStatus").value;

        if (jenisFilter) {
          filtered = filtered.filter((k) => k.jenis === jenisFilter);
        }
        if (statusFilter) {
          filtered = filtered.filter((k) => k.status === statusFilter);
        }

        const container = document.getElementById("daftarKonsol");
        container.innerHTML = "";

        filtered.sort((a, b) => {
          // Urutan PS5 > PS4 > PS3 > PS2
          const urutanJenis = { PS5: 1, PS4: 2, PS3: 3, PS2: 4 };

          const jenisA = urutanJenis[a.jenis] || 99;
          const jenisB = urutanJenis[b.jenis] || 99;

          if (jenisA !== jenisB) {
            return jenisA - jenisB;
          }

          // Ekstrak nomor dari nama konsol (misal: PS5 #004 -> 4)
          const nomorA = parseInt(a.nama.match(/\d+$/)?.[0]) || 0;
          const nomorB = parseInt(b.nama.match(/\d+$/)?.[0]) || 0;

          return nomorA - nomorB;
        });

        filtered.forEach((konsol) => {
          const statusClass = {
            tersedia: "status-available",
            disewa: "status-rented",
            maintenance: "status-maintenance",
          };

          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
                    <div class="card-header">
                        <div>
                            <div class="card-title">${konsol.nama} (${
            konsol.jenis
          })</div>
                            <p>Rp ${konsol.harga.toLocaleString(
                              "id-ID"
                            )}/jam</p>
                            <span class="status-badge ${
                              statusClass[konsol.status]
                            }">${konsol.status}</span>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-warning" onclick="editKonsol(${
                              konsol.id
                            })">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger" onclick="hapusKonsol(${
                              konsol.id
                            })">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
          container.appendChild(card);
        });
        updateKonsolDashboard();
      }

      function updateKonsolDashboard() {
        const total = data.konsol.length;
        const tersedia = data.konsol.filter(
          (k) => k.status === "tersedia"
        ).length;
        const disewa = data.konsol.filter((k) => k.status === "disewa").length;
        const maintenance = data.konsol.filter(
          (k) => k.status === "maintenance"
        ).length;

        const container = document.getElementById("konsolDashboard");
        container.innerHTML = `
    <div class="stat-card">
      <div class="stat-number">${total}</div>
      <div class="stat-label">Total Konsol</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">${tersedia}</div>
      <div class="stat-label">Tersedia</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">${disewa}</div>
      <div class="stat-label">Disewa</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">${maintenance}</div>
      <div class="stat-label">Maintenance</div>
    </div>
  `;
      }

      function filterKonsol() {
        displayKonsol();
      }

      function resetFilter() {
        document.getElementById("filterJenis").value = "";
        document.getElementById("filterStatus").value = "";
        displayKonsol();
      }

      function editKonsol(id) {
        const konsol = data.konsol.find((k) => k.id === id);
        if (!konsol) return;

        document.getElementById("modalTitle").textContent = "Edit Konsol";
        document.getElementById("modalBody").innerHTML = `
                <div class="form-group">
                    <label>Nama Konsol</label>
                    <input type="text" id="editKonsolNama" value="${
                      konsol.nama
                    }">
                </div>
                <div class="form-group">
                    <label>Jenis</label>
                    <select id="editKonsolJenis">
                        <option value="PS5" ${
                          konsol.jenis === "PS5" ? "selected" : ""
                        }>PlayStation 5</option>
                        <option value="PS4" ${
                          konsol.jenis === "PS4" ? "selected" : ""
                        }>PlayStation 4</option>
                        <option value="PS3" ${
                          konsol.jenis === "PS3" ? "selected" : ""
                        }>PlayStation 3</option>
                        <option value="PS2" ${
                          konsol.jenis === "PS2" ? "selected" : ""
                        }>PlayStation 2</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Harga per Jam (Rp)</label>
                    <input type="number" id="editKonsolHarga" value="${
                      konsol.harga
                    }">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="editKonsolStatus">
                        <option value="tersedia" ${
                          konsol.status === "tersedia" ? "selected" : ""
                        }>Tersedia</option>
                        <option value="disewa" ${
                          konsol.status === "disewa" ? "selected" : ""
                        }>Disewa</option>
                        <option value="maintenance" ${
                          konsol.status === "maintenance" ? "selected" : ""
                        }>Maintenance</option>
                    </select>
                </div>
            `;

        document.getElementById("saveBtn").onclick = function () {
          konsol.nama = document.getElementById("editKonsolNama").value;
          konsol.jenis = document.getElementById("editKonsolJenis").value;
          konsol.harga = parseInt(
            document.getElementById("editKonsolHarga").value
          );
          konsol.status = document.getElementById("editKonsolStatus").value;

          saveData();
          displayKonsol();
          closeModal();
        };

        document.getElementById("editModal").style.display = "block";
      }

      function hapusKonsol(id) {
        if (confirm("Yakin ingin menghapus konsol ini?")) {
          data.konsol = data.konsol.filter((k) => k.id !== id);
          saveData();
          displayKonsol();
        }
      }

      // Booking Management
      function updateBookingKonsolOptions() {
        const select = document.getElementById("bookingKonsol");
        select.innerHTML = '<option value="">Pilih Konsol</option>';

        // Ambil hanya konsol yang tersedia
        const tersedia = data.konsol.filter((k) => k.status === "tersedia");

        // Urutkan berdasarkan jenis dan nomor
        tersedia.sort((a, b) => {
          const urutanJenis = { PS5: 1, PS4: 2, PS3: 3, PS2: 4 };

          const jenisA = urutanJenis[a.jenis] || 99;
          const jenisB = urutanJenis[b.jenis] || 99;

          if (jenisA !== jenisB) return jenisA - jenisB;

          const nomorA = parseInt(a.nama.match(/\d+$/)?.[0]) || 0;
          const nomorB = parseInt(b.nama.match(/\d+$/)?.[0]) || 0;

          return nomorA - nomorB;
        });

        // Masukkan ke dropdown
        tersedia.forEach((konsol) => {
          const option = document.createElement("option");
          option.value = konsol.id;
          option.textContent = `${
            konsol.nama
          } - Rp ${konsol.harga.toLocaleString("id-ID")}/jam`;
          select.appendChild(option);
        });
      }

      function updateBookingMemberOptions() {
        const select = document.getElementById("bookingMember");
        select.innerHTML = '<option value="">Bukan Member</option>';

        data.member.forEach((member) => {
          const option = document.createElement("option");
          option.value = member.id;
          option.textContent = `${member.nama} (${member.jenis})`;
          select.appendChild(option);
        });
      }

      function tambahBooking() {
        const nama = document.getElementById("bookingNama").value;
        const konsolId = parseInt(
          document.getElementById("bookingKonsol").value
        );
        const mulai = document.getElementById("bookingMulai").value;
        const durasi = parseInt(document.getElementById("bookingDurasi").value);
        const memberId = document.getElementById("bookingMember").value;

        if (!nama || !konsolId || !mulai || !durasi) {
          alert("Semua field harus diisi!");
          return;
        }

        const konsol = data.konsol.find((k) => k.id === konsolId);
        let total = konsol.harga * durasi;

        // Apply member discount
        if (memberId) {
          const member = data.member.find((m) => m.id === parseInt(memberId));
          const discounts = {
            bronze: 0.05,
            silver: 0.1,
            gold: 0.15,
            platinum: 0.2,
          };
          total = total * (1 - discounts[member.jenis]);
        }

        const booking = {
          id: data.nextId.booking++,
          nama,
          konsolId,
          konsolNama: konsol.nama,
          mulai,
          durasi,
          member: memberId
            ? data.member.find((m) => m.id === parseInt(memberId))
            : null,
          total,
          status: "aktif",
        };

        data.booking.push(booking);

        // Update konsol status
        konsol.status = "disewa";

        saveData();
        displayBooking();
        updateBookingKonsolOptions();

        // Clear form
        document.getElementById("bookingNama").value = "";
        document.getElementById("bookingKonsol").value = "";
        document.getElementById("bookingMulai").value = "";
        document.getElementById("bookingDurasi").value = "";
        document.getElementById("bookingMember").value = "";
      }

      function displayBooking() {
        const container = document.getElementById("daftarBooking");
        container.innerHTML = "";

        data.booking.forEach((booking) => {
          const mulaiDate = new Date(booking.mulai);
          const selesaiDate = new Date(
            mulaiDate.getTime() + booking.durasi * 60 * 60 * 1000
          );

          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
                    <div class="card-header">
                        <div>
                            <div class="card-title">${booking.nama}</div>
                            <p><strong>Konsol:</strong> ${
                              booking.konsolNama
                            }</p>
                            <p><strong>Waktu:</strong> ${mulaiDate.toLocaleString(
                              "id-ID"
                            )} - ${selesaiDate.toLocaleString("id-ID")}</p>
                            <p><strong>Durasi:</strong> ${
                              booking.durasi
                            } jam</p>
                            ${
                              booking.member
                                ? `<p><strong>Member:</strong> ${booking.member.nama} (${booking.member.jenis})</p>`
                                : ""
                            }
                            <p><strong>Total:</strong> Rp ${booking.total.toLocaleString(
                              "id-ID"
                            )}</p>
                            <span class="status-badge ${
                              booking.status === "aktif"
                                ? "status-rented"
                                : "status-available"
                            }">${booking.status}</span>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-warning" onclick="editBooking(${
                              booking.id
                            })">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger" onclick="hapusBooking(${
                              booking.id
                            })">
                                <i class="fas fa-trash"></i>
                            </button>
                            ${
                              booking.status === "aktif"
                                ? `<button class="btn" onclick="selesaikanBooking(${booking.id})"><i class="fas fa-check"></i> Selesai</button>`
                                : ""
                            }
                        </div>
                    </div>
                `;
          container.appendChild(card);
        });
      }

      function editBooking(id) {
        const booking = data.booking.find((b) => b.id === id);
        if (!booking) return;

        document.getElementById("modalTitle").textContent = "Edit Booking";
        document.getElementById("modalBody").innerHTML = `
                <div class="form-group">
                    <label>Nama Customer</label>
                    <input type="text" id="editBookingNama" value="${
                      booking.nama
                    }">
                </div>
                <div class="form-group">
                    <label>Tanggal & Waktu Mulai</label>
                    <input type="datetime-local" id="editBookingMulai" value="${booking.mulai.slice(
                      0,
                      16
                    )}">
                </div>
                <div class="form-group">
                    <label>Durasi (Jam)</label>
                    <input type="number" id="editBookingDurasi" value="${
                      booking.durasi
                    }" min="1">
                </div>
            `;

        document.getElementById("saveBtn").onclick = function () {
          const konsol = data.konsol.find((k) => k.id === booking.konsolId);
          booking.nama = document.getElementById("editBookingNama").value;
          booking.mulai = document.getElementById("editBookingMulai").value;
          booking.durasi = parseInt(
            document.getElementById("editBookingDurasi").value
          );

          // Recalculate total
          let total = konsol.harga * booking.durasi;
          if (booking.member) {
            const discounts = {
              bronze: 0.05,
              silver: 0.1,
              gold: 0.15,
              platinum: 0.2,
            };
            total = total * (1 - discounts[booking.member.jenis]);
          }
          booking.total = total;

          saveData();
          displayBooking();
          closeModal();
        };

        document.getElementById("editModal").style.display = "block";
      }

      function hapusBooking(id) {
        if (confirm("Yakin ingin menghapus booking ini?")) {
          const booking = data.booking.find((b) => b.id === id);
          if (booking && booking.status === "aktif") {
            // Free up the console
            const konsol = data.konsol.find((k) => k.id === booking.konsolId);
            if (konsol) konsol.status = "tersedia";
          }

          data.booking = data.booking.filter((b) => b.id !== id);
          saveData();
          displayBooking();
          updateBookingKonsolOptions();
        }
      }

      function selesaikanBooking(id) {
        const booking = data.booking.find((b) => b.id === id);
        if (booking) {
          booking.status = "selesai";

          // Free up the console
          const konsol = data.konsol.find((k) => k.id === booking.konsolId);
          if (konsol) konsol.status = "tersedia";

          saveData();
          displayBooking();
          updateBookingKonsolOptions();
        }
      }

      // Member Management
      function tambahMember() {
        const nama = document.getElementById("memberNama").value;
        const telepon = document.getElementById("memberTelepon").value;
        const email = document.getElementById("memberEmail").value;
        const jenis = document.getElementById("memberJenis").value;

        if (!nama || !telepon) {
          alert("Nama dan nomor telepon harus diisi!");
          return;
        }

        const member = {
          id: data.nextId.member++,
          nama,
          telepon,
          email,
          jenis,
          tanggalDaftar: new Date().toISOString(),
        };

        data.member.push(member);
        saveData();
        displayMember();

        // Clear form
        document.getElementById("memberNama").value = "";
        document.getElementById("memberTelepon").value = "";
        document.getElementById("memberEmail").value = "";
      }

      function displayMember() {
        const container = document.getElementById("daftarMember");
        container.innerHTML = "";

        data.member.forEach((member) => {
          const discounts = {
            bronze: "5%",
            silver: "10%",
            gold: "15%",
            platinum: "20%",
          };

          const card = document.createElement("div");
          card.className = "member-card";
          card.innerHTML = `
                    <div class="member-type">${member.jenis.toUpperCase()} - ${
            discounts[member.jenis]
          } discount</div>
                    <div class="card-header">
                        <div>
                            <div class="card-title">${member.nama}</div>
                            <p><strong>Telepon:</strong> ${member.telepon}</p>
                            ${
                              member.email
                                ? `<p><strong>Email:</strong> ${member.email}</p>`
                                : ""
                            }
                            <p><strong>Terdaftar:</strong> ${new Date(
                              member.tanggalDaftar
                            ).toLocaleDateString("id-ID")}</p>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-warning" onclick="editMember(${
                              member.id
                            })">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger" onclick="hapusMember(${
                              member.id
                            })">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
          container.appendChild(card);
        });
      }

      function editMember(id) {
        const member = data.member.find((m) => m.id === id);
        if (!member) return;

        document.getElementById("modalTitle").textContent = "Edit Member";
        document.getElementById("modalBody").innerHTML = `
                <div class="form-group">
                    <label>Nama Member</label>
                    <input type="text" id="editMemberNama" value="${
                      member.nama
                    }">
                </div>
                <div class="form-group">
                    <label>No. Telepon</label>
                    <input type="tel" id="editMemberTelepon" value="${
                      member.telepon
                    }">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="editMemberEmail" value="${
                      member.email || ""
                    }">
                </div>
                <div class="form-group">
                    <label>Jenis Member</label>
                    <select id="editMemberJenis">
                        <option value="bronze" ${
                          member.jenis === "bronze" ? "selected" : ""
                        }>Bronze (5% discount)</option>
                        <option value="silver" ${
                          member.jenis === "silver" ? "selected" : ""
                        }>Silver (10% discount)</option>
                        <option value="gold" ${
                          member.jenis === "gold" ? "selected" : ""
                        }>Gold (15% discount)</option>
                        <option value="platinum" ${
                          member.jenis === "platinum" ? "selected" : ""
                        }>Platinum (20% discount)</option>
                    </select>
                </div>
            `;

        document.getElementById("saveBtn").onclick = function () {
          member.nama = document.getElementById("editMemberNama").value;
          member.telepon = document.getElementById("editMemberTelepon").value;
          member.email = document.getElementById("editMemberEmail").value;
          member.jenis = document.getElementById("editMemberJenis").value;

          saveData();
          displayMember();
          updateBookingMemberOptions();
          closeModal();
        };

        document.getElementById("editModal").style.display = "block";
      }

      function hapusMember(id) {
        if (confirm("Yakin ingin menghapus member ini?")) {
          data.member = data.member.filter((m) => m.id !== id);
          saveData();
          displayMember();
          updateBookingMemberOptions();
        }
      }

      // Rekap Management
      function generateRekap() {
        const bulan = document.getElementById("rekapBulan").value;
        if (!bulan) {
          alert("Pilih bulan terlebih dahulu!");
          return;
        }

        const [tahun, bulanNum] = bulan.split("-");
        const startDate = new Date(tahun, bulanNum - 1, 1);
        const endDate = new Date(tahun, bulanNum, 0, 23, 59, 59, 999);

        // Filter bookings for the selected month
        const bookingsBulan = data.booking.filter((b) => {
          const bookingDate = new Date(b.mulai);
          return bookingDate >= startDate && bookingDate <= endDate;
        });

        // Calculate statistics
        const stats = {
          totalBooking: bookingsBulan.length,
          totalPendapatan: bookingsBulan.reduce((sum, b) => sum + b.total, 0),
          totalJam: bookingsBulan.reduce((sum, b) => sum + b.durasi, 0),
        };

        // Group by console type
        const konsoleStats = {};
        data.konsol.forEach((konsol) => {
          konsoleStats[konsol.jenis] = {
            nama: konsol.jenis,
            totalBooking: 0,
            totalJam: 0,
            totalPendapatan: 0,
          };
        });

        bookingsBulan.forEach((booking) => {
          const konsol = data.konsol.find((k) => k.id === booking.konsolId);
          if (konsol && konsoleStats[konsol.jenis]) {
            konsoleStats[konsol.jenis].totalBooking++;
            konsoleStats[konsol.jenis].totalJam += booking.durasi;
            konsoleStats[konsol.jenis].totalPendapatan += booking.total;
          }
        });

        displayRekap(stats, konsoleStats, bulan);
      }

      function displayRekap(stats, konsoleStats, bulan) {
        const container = document.getElementById("hasilRekap");
        const [tahun, bulanNum] = bulan.split("-");
        const namaBulan = new Date(tahun, bulanNum - 1).toLocaleDateString(
          "id-ID",
          { month: "long", year: "numeric" }
        );

        container.innerHTML = `
                <h3>Rekap Bulan ${namaBulan}</h3>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${stats.totalBooking}</div>
                        <div class="stat-label">Total Booking</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.totalJam}</div>
                        <div class="stat-label">Total Jam Main</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">Rp ${stats.totalPendapatan.toLocaleString(
                          "id-ID"
                        )}</div>
                        <div class="stat-label">Total Pendapatan</div>
                    </div>
                </div>

                <h4>Statistik per Jenis Konsol</h4>
                <div id="konsolStats"></div>
            `;

        const konsolStatsContainer = document.getElementById("konsolStats");
        Object.values(konsoleStats).forEach((stat) => {
          if (stat.totalBooking > 0) {
            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
                        <div class="card-title">${stat.nama}</div>
                        <p><strong>Total Booking:</strong> ${
                          stat.totalBooking
                        }</p>
                        <p><strong>Total Jam:</strong> ${stat.totalJam}</p>
                        <p><strong>Total Pendapatan:</strong> Rp ${stat.totalPendapatan.toLocaleString(
                          "id-ID"
                        )}</p>
                    `;
            konsolStatsContainer.appendChild(card);
          }
        });
      }

      // Modal Management
      function closeModal() {
        document.getElementById("editModal").style.display = "none";
      }

      // Initialize app
      window.onclick = function (event) {
        const modal = document.getElementById("editModal");
        if (event.target === modal) {
          closeModal();
        }
      };

      // Load data and initialize display
      window.onload = function () {
        loadData();
        displayKonsol();
        updateBookingKonsolOptions();
        updateBookingMemberOptions();
      };

      function exportRekapToPDF() {
        const element = document.getElementById("hasilRekap");

        if (!element.innerHTML.trim()) {
          alert("Silakan generate rekap terlebih dahulu.");
          return;
        }

        const opt = {
          margin: 0.5,
          filename: `rekap-bulanan-${
            document.getElementById("rekapBulan").value
          }.pdf`,
          image: { type: "jpeg", quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: "in", format: "a4", orientation: "portrait" },
        };

        html2pdf().set(opt).from(element).save();
      }

      function getSemuaBulanBooking() {
        const bulanSet = new Set();
        data.booking.forEach((b) => {
          const d = new Date(b.mulai);
          const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(
            2,
            "0"
          )}`;
          bulanSet.add(key);
        });
        return Array.from(bulanSet).sort();
      }

      function isiDropdownBulanExport() {
        const select = document.getElementById("bulanExport");
        select.innerHTML = "";
        const bulanList = getSemuaBulanBooking();

        bulanList.forEach((b) => {
          const option = document.createElement("option");
          option.value = b;
          option.textContent = new Date(`${b}-01`).toLocaleDateString("id-ID", {
            month: "long",
            year: "numeric",
          });
          select.appendChild(option);
        });
      }

      function eksporRekapBeberapaBulan(bulanTunggal = null) {
        const selected = bulanTunggal
          ? [bulanTunggal]
          : Array.from(
              document.getElementById("bulanExport").selectedOptions
            ).map((opt) => opt.value);

        if (selected.length === 0) return alert("Pilih minimal satu bulan!");

        const wrapper = document.createElement("div");
        wrapper.style.fontFamily = "Segoe UI, sans-serif";
        wrapper.style.padding = "20px";
        wrapper.style.color = "#333";

        selected.forEach((bulan) => {
          const [tahun, bulanNum] = bulan.split("-");
          const startDate = new Date(tahun, bulanNum - 1, 1);
          const endDate = new Date(tahun, bulanNum, 0, 23, 59, 59);

          const bookings = data.booking.filter((b) => {
            const tgl = new Date(b.mulai);
            return tgl >= startDate && tgl <= endDate;
          });

          if (bookings.length === 0) return;

          const totalBooking = bookings.length;
          const totalDurasi = bookings.reduce((sum, b) => sum + b.durasi, 0);
          const totalPendapatan = bookings.reduce((sum, b) => sum + b.total, 0);
          const konsolUnik = new Set(bookings.map((b) => b.konsolNama)).size;

          const section = document.createElement("div");
          section.style.pageBreakAfter = "always";
          section.innerHTML = `
      <div style="text-align:center; margin-bottom:20px;">
        <h1 style="color:#764ba2;"> Rekap Bulanan</h1>
        <h2 style="color:#333;">${new Date(`${bulan}-01`).toLocaleDateString(
          "id-ID",
          { month: "long", year: "numeric" }
        )}</h2>
      </div>

      <table style="width:100%; border-collapse: collapse; margin-bottom: 25px;">
        <thead style="background:#667eea; color:white;">
          <tr>
            <th style="padding:10px; border:1px solid #ccc;">Customer</th>
            <th style="padding:10px; border:1px solid #ccc;">Konsol</th>
            <th style="padding:10px; border:1px solid #ccc;">Durasi (Jam)</th>
            <th style="padding:10px; border:1px solid #ccc;">Total (Rp)</th>
          </tr>
        </thead>
        <tbody>
          ${bookings
            .map(
              (b) => `
              <tr>
                <td style="padding:8px; border:1px solid #eee;">${b.nama}</td>
                <td style="padding:8px; border:1px solid #eee;">${
                  b.konsolNama
                }</td>
                <td style="padding:8px; border:1px solid #eee; text-align:center;">${
                  b.durasi
                }</td>
                <td style="padding:8px; border:1px solid #eee; text-align:right;">Rp ${b.total.toLocaleString(
                  "id-ID"
                )}</td>
              </tr>
            `
            )
            .join("")}
        </tbody>
      </table>

      <div style="
        display: flex;
        justify-content: space-around;
        margin-top: 30px;
        padding: 20px;
        background: #f0f0f0;
        border-radius: 15px;
        font-size: 16px;
        font-weight: bold;
        color: #333;
        text-align: center;
        gap: 20px;
      ">
        <div style="flex: 1;">
          <br>Total Booking<br><span style="font-size: 20px; color:#764ba2;">${totalBooking}</span>
        </div>
        <div style="flex: 1;">
          <br>Total Jam<br><span style="font-size: 20px; color:#764ba2;">${totalDurasi} jam</span>
        </div>
        <div style="flex: 1;">
          <br>Total Pendapatan<br><span style="font-size: 20px; color:#764ba2;">Rp ${totalPendapatan.toLocaleString(
            "id-ID"
          )}</span>
        </div>
        <div style="flex: 1;">
          <br>Konsol Dirental<br><span style="font-size: 20px; color:#764ba2;">${konsolUnik} unit</span>
        </div>
      </div>
    `;

          wrapper.appendChild(section);
        });

        html2pdf()
          .from(wrapper)
          .set({
            filename:
              selected.length === 1
                ? `rekap-${selected[0]}.pdf`
                : "rekap-gabungan.pdf",
            margin: 0.5,
            html2canvas: { scale: 2 },
            jsPDF: { unit: "in", format: "a4", orientation: "portrait" },
          })
          .save();
      }

      function bukaExportPDFModal() {
        isiDropdownBulanExport();
        document.getElementById("exportPDFModal").style.display = "block";
      }

      function tutupExportPDFModal() {
        document.getElementById("exportPDFModal").style.display = "none";
      }

      function handleEksporPDF() {
        const currentBulan = document.getElementById("rekapBulan").value;
        const hasil = document.getElementById("hasilRekap").innerHTML.trim();

        if (hasil && currentBulan) {
          // Sudah generate rekap  langsung ekspor
          eksporRekapBeberapaBulan(currentBulan);
        } else {
          // Belum generate  tampilkan dropdown modal
          bukaExportPDFModal();
        }
      }

      function resetRekap() {
        // Ambil bulan saat ini dalam format yyyy-mm
        const now = new Date();
        const bulanSekarang = `${now.getFullYear()}-${String(
          now.getMonth() + 1
        ).padStart(2, "0")}`;

        // Set kembali input bulan ke bulan sekarang
        document.getElementById("rekapBulan").value = bulanSekarang;

        // Bersihkan hasil rekap yang ditampilkan
        document.getElementById("hasilRekap").innerHTML = "";
      }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  </body>
</html>
